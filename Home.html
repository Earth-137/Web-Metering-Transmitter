<!DOCTYPE html>
<html>
  <head>
    
    <style>
    body {
    background-color: #03045E
    } 
    
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 50px;
    }
    .back-button {
      position: absolute;
      top: 10px;
      left: 10px;
    }
    </style>

  <body>
    <h1>Tabel Data Monitoring Transmitter TVRI Sulawesi Tengah</h1>

    <div id="controls">
      <!-- Dropdown 1: Lokasi Transmisi -->
      <label for="locationDropdown">Lokasi Transmisi:</label>
      <select id="locationDropdown" onchange="loadEmployees()">
        <option value="">Memuat Lokasi...</option>
      </select>
      
      <!-- Dropdown 2: Nama Pegawai (tergantung Lokasi) -->
      <label for="employeeDropdown">Nama Pegawai:</label>
      <select id="employeeDropdown" disabled>
        <option value="">Pilih Lokasi Dulu</option>
      </select>

      <!-- Filter Tanggal -->
      <label for="startDate">Tanggal Mulai:</label>
      <input type="date" id="startDate" name="startDate">
      
      <label for="endDate">Tanggal Akhir:</label>
      <input type="date" id="endDate" name="endDate">
      
      <button onclick="filterData()">Filter Data</button>
      <span id="loader">Memuat...</span>
    </div>

    <div id="table-container">
      <p>Masukkan semua kriteria filter dan klik **Filter Data**.</p>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Muat Lokasi saat halaman dimuat
        loadLocations();
      });
      
      // ===============================================
      // FUNGSI DROPDOWN BERANTAI (CHAINED DROPDOWN)
      // ===============================================
      
      /**
       * Memanggil fungsi server untuk mendapatkan daftar lokasi unik.
       */
      function loadLocations() {
        google.script.run
          .withSuccessHandler(populateLocations)
          .withFailureHandler(onFilterFailure)
          .getUniqueLocations();
      }

      /**
       * Mengisi Dropdown Lokasi Transmisi.
       * @param {Array<string>} locations Daftar lokasi unik.
       */
      function populateLocations(locations) {
        const select = document.getElementById('locationDropdown');
        select.innerHTML = '<option value="ALL"> Semua Lokasi </option>'; // Opsi default

        locations.forEach(loc => {
          select.innerHTML += `<option value="${loc}">${loc}</option>`;
        });
        
        // Setelah lokasi dimuat, muat pegawai untuk state awal (ALL)
        loadEmployees(); 
      }

      /**
       * Dipanggil saat Dropdown Lokasi berubah. Memanggil server untuk mendapatkan pegawai.
       */
      function loadEmployees() {
        const location = document.getElementById('locationDropdown').value;
        const employeeSelect = document.getElementById('employeeDropdown');
        
        employeeSelect.innerHTML = '<option value="">Memuat Pegawai...</option>';
        employeeSelect.disabled = true;

        if (!location) {
          employeeSelect.innerHTML = '<option value="">Pilih Lokasi Dulu</option>';
          return;
        }

        // Panggil fungsi server untuk mendapatkan pegawai berdasarkan lokasi yang dipilih
        google.script.run
          .withSuccessHandler(populateEmployees)
          .withFailureHandler(onFilterFailure)
          .getEmployeesByLocation(location);
      }

      /**
       * Mengisi Dropdown Nama Pegawai.
       * @param {Array<string>} employees Daftar nama pegawai unik.
       */
      function populateEmployees(employees) {
        const select = document.getElementById('employeeDropdown');
        select.innerHTML = '<option value="ALL"> Semua Pegawai </option>'; // Opsi default
        
        employees.forEach(emp => {
          select.innerHTML += `<option value="${emp}">${emp}</option>`;
        });
        select.disabled = false;
      }

      // ===============================================
      // FUNGSI FILTER DATA UTAMA
      // ===============================================
      
      function filterData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const locationFilter = document.getElementById('locationDropdown').value;
        const employeeFilter = document.getElementById('employeeDropdown').value;
        
        const loader = document.getElementById('loader');
        const button = document.querySelector('button');
        const container = document.getElementById('table-container');

        if (!startDate || !endDate || !locationFilter || !employeeFilter) {
          container.innerHTML = '<p style="color: red;">⚠️ Mohon lengkapi Tanggal Mulai, Tanggal Akhir, Lokasi, dan Pegawai sebelum filter.</p>';
          return;
        }

        // Tampilkan loader dan nonaktifkan tombol
        loader.style.display = 'inline';
        button.disabled = true;
        container.innerHTML = ''; 

        // Panggil fungsi server yang telah dimodifikasi (getFilteredData)
        google.script.run
          .withSuccessHandler(displayFilteredData)
          .withFailureHandler(onFilterFailure)
          .getFilteredData(startDate, endDate, locationFilter, employeeFilter); 
      }

      /**
       * Menangani data yang berhasil difilter dan menampilkannya sebagai tabel HTML.
       */
      function displayFilteredData(data) {
        const container = document.getElementById('table-container');
        const loader = document.getElementById('loader');
        const button = document.querySelector('button');

        loader.style.display = 'none';
        button.disabled = false;

        if (data.length <= 1) { 
          container.innerHTML = '<p>❌ Tidak ada data yang ditemukan berdasarkan kriteria filter yang dipilih.</p>';
          return;
        }

        let html = '<table><thead><tr>';

        // Header (baris pertama)
        data[0].forEach(header => {
          html += `<th>${header}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Baris data
        for (let i = 1; i < data.length; i++) {
          html += '<tr>';
          data[i].forEach(cell => {
            html += `<td>${cell}</td>`;
          });
          html += '</tr>';
        }
        
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      /**
       * Menangani kegagalan saat memanggil fungsi server.
       */
      function onFilterFailure(error) {
        const container = document.getElementById('table-container');
        const loader = document.getElementById('loader');
        const button = document.querySelector('button');
        
        loader.style.display = 'none';
        button.disabled = false;
        container.innerHTML = `<p style="color: red;">Terjadi kesalahan saat memproses filter: ${error.message}</p>`;
      }
    </script>
  </body>
</html>